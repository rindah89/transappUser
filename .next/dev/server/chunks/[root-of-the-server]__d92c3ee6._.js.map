{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/remyngwanyam/Desktop/transapp/transapp-user-master/src/lib/supabase.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport { Database } from '../types/database.types';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl) {\n  throw new Error('Missing NEXT_PUBLIC_SUPABASE_URL or SUPABASE_URL environment variable');\n}\n\nif (!supabaseAnonKey && !supabaseServiceKey) {\n  throw new Error('Missing NEXT_PUBLIC_SUPABASE_ANON_KEY, NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY, or SUPABASE_SERVICE_ROLE_KEY environment variable');\n}\n\n// Client for client-side operations (uses anon/publishable key, respects RLS)\nexport const supabase = supabaseAnonKey\n  ? createClient<Database>(supabaseUrl, supabaseAnonKey, {\n      auth: {\n        persistSession: true,\n        autoRefreshToken: true,\n        detectSessionInUrl: true\n      }\n    })\n  : null;\n\n// Client for server-side admin operations (uses service role key - REQUIRED for API routes)\n// WARNING: Only use this in API routes or getServerSideProps. NEVER expose to client.\n// Only check for service key on server side (not during client-side module evaluation)\nconst isServer = typeof window === 'undefined';\n\nif (isServer && !supabaseServiceKey) {\n  console.error('⚠️  SUPABASE_SERVICE_ROLE_KEY is missing! Server-side API routes will not work.');\n  console.error('   Get it from: Supabase Dashboard → Settings → API → service_role key');\n  console.error('   Make sure it\\'s in your .env.local file (not .env, as .env.local is not committed to git)');\n}\n\nexport const supabaseAdmin = supabaseServiceKey\n  ? createClient<Database>(supabaseUrl, supabaseServiceKey, {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n        detectSessionInUrl: false\n      },\n      db: {\n        schema: 'public'\n      }\n    })\n  : (() => {\n      // Only throw error on server side when actually trying to use it\n      if (isServer) {\n        throw new Error(\n          'SUPABASE_SERVICE_ROLE_KEY is required for server-side operations.\\n' +\n          'Please add it to your .env.local file:\\n' +\n          'SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here\\n' +\n          'Get it from: Supabase Dashboard → Settings → API → service_role key'\n        );\n      }\n      // On client side, return a dummy object that will throw if used\n      return null as any;\n    })();\n"],"names":[],"mappings":";;;;;;AAAA;;AAGA,MAAM,cAAc,gFAAwC,QAAQ,GAAG,CAAC,YAAY;AACpF,MAAM,kBAAkB,QAAQ,GAAG,CAAC,6BAA6B;AACjE,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;AAEhE;;AAIA;;AAKO,MAAM,WAAW,uCACpB,IAAA,yLAAY,EAAW,aAAa,iBAAiB;IACnD,MAAM;QACJ,gBAAgB;QAChB,kBAAkB;QAClB,oBAAoB;IACtB;AACF,KACA;AAEJ,4FAA4F;AAC5F,sFAAsF;AACtF,uFAAuF;AACvF,MAAM,WAAW,kDAAkB;AAEnC,IAAI,YAAY,CAAC,oBAAoB;IACnC,QAAQ,KAAK,CAAC;IACd,QAAQ,KAAK,CAAC;IACd,QAAQ,KAAK,CAAC;AAChB;AAEO,MAAM,gBAAgB,qBACzB,IAAA,yLAAY,EAAW,aAAa,oBAAoB;IACtD,MAAM;QACJ,kBAAkB;QAClB,gBAAgB;QAChB,oBAAoB;IACtB;IACA,IAAI;QACF,QAAQ;IACV;AACF,KACA,CAAC;IACC,iEAAiE;IACjE,wCAAc;QACZ,MAAM,IAAI,MACR,wEACA,6CACA,2DACA;IAEJ;IACA,gEAAgE;IAChE,OAAO;AACT,CAAC"}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///Users/remyngwanyam/Desktop/transapp/transapp-user-master/src/exceptions/HttpException.ts"],"sourcesContent":["export class HttpException extends Error {\n  public status: number;\n  public message: string;\n\n  constructor(status: number, message: string) {\n    super(message);\n    this.status = status;\n    this.message = message;\n  }\n}\n"],"names":[],"mappings":";;;;AAAO,MAAM,sBAAsB;IAC1B,OAAe;IACf,QAAgB;IAEvB,YAAY,MAAc,EAAE,OAAe,CAAE;QAC3C,KAAK,CAAC;QACN,IAAI,CAAC,MAAM,GAAG;QACd,IAAI,CAAC,OAAO,GAAG;IACjB;AACF"}},
    {"offset": {"line": 115, "column": 0}, "map": {"version":3,"sources":["file:///Users/remyngwanyam/Desktop/transapp/transapp-user-master/src/utils/util.ts"],"sourcesContent":["/**\n * @method isEmpty\n * @param {String | Number | Object} value\n * @returns {Boolean} true & false\n * @description this value is Empty Check\n */\nexport const isEmpty = (value: string | number | object): boolean => {\n  if (value === null) {\n    return true;\n  } else if (typeof value !== 'number' && value === '') {\n    return true;\n  } else if (typeof value === 'undefined' || value === undefined) {\n    return true;\n  } else if (value !== null && typeof value === 'object' && !Object.keys(value).length) {\n    return true;\n  } else {\n    return false;\n  }\n};\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AACM,MAAM,UAAU,CAAC;IACtB,IAAI,UAAU,MAAM;QAClB,OAAO;IACT,OAAO,IAAI,OAAO,UAAU,YAAY,UAAU,IAAI;QACpD,OAAO;IACT,OAAO,IAAI,OAAO,UAAU,eAAe,UAAU,WAAW;QAC9D,OAAO;IACT,OAAO,IAAI,UAAU,QAAQ,OAAO,UAAU,YAAY,CAAC,OAAO,IAAI,CAAC,OAAO,MAAM,EAAE;QACpF,OAAO;IACT,OAAO;QACL,OAAO;IACT;AACF"}},
    {"offset": {"line": 141, "column": 0}, "map": {"version":3,"sources":["file:///Users/remyngwanyam/Desktop/transapp/transapp-user-master/src/services/user.auth.service.ts"],"sourcesContent":["import { supabaseAdmin } from '@databases/supabase';\nimport { HttpException } from '../exceptions/HttpException';\nimport { isEmpty } from '../utils/util';\nimport type { UserInsert, User } from '../interfaces/user.interface';\n\nclass UserAuthService {\n  /**\n   * Sign up a new user using Supabase Auth\n   * Creates auth user and then creates user record in users table\n   */\n  public async signup(userData: {\n    email: string;\n    password: string;\n    name?: string;\n    sex?: string;\n    age?: number;\n    phoneNumber?: string;\n    idCardNumber?: string;\n  }): Promise<{ user: User; session: any }> {\n    if (isEmpty(userData)) throw new HttpException(400, 'Invalid credentials!');\n    if (!userData.password || userData.password.length < 6) {\n      throw new HttpException(400, 'Password must be at least 6 characters');\n    }\n\n    // Step 1: Create auth user using Supabase Admin API\n    // We confirm the email immediately so the user can be logged in right after signup.\n    const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({\n      email: userData.email,\n      password: userData.password,\n      email_confirm: true,\n      user_metadata: {\n        name: userData.name,\n        phone_number: userData.phoneNumber,\n      },\n    });\n\n    if (authError) {\n      if (authError.message.includes('already registered')) {\n        throw new HttpException(409, 'This email already exists');\n      }\n      throw new HttpException(500, authError.message);\n    }\n\n    if (!authData.user) {\n      throw new HttpException(500, 'Failed to create auth user');\n    }\n\n    // Step 2: Create user record in users table with auth user ID\n    const userInsert: UserInsert = {\n      auth_id: authData.user.id, // Link to Supabase Auth user UUID\n      email: userData.email,\n      name: userData.name || null,\n      sex: userData.sex || null,\n      age: userData.age || null,\n      phone_number: userData.phoneNumber || null,\n      id_card_number: userData.idCardNumber || null,\n    };\n\n    const { data: newUser, error: insertError } = await supabaseAdmin\n      .from('users')\n      .insert(userInsert)\n      .select()\n      .single();\n\n    if (insertError) {\n      // If user table insert fails, try to clean up auth user\n      if (authData.user) {\n        await supabaseAdmin.auth.admin.deleteUser(authData.user.id);\n      }\n      \n      if (insertError.code === '23505') {\n        throw new HttpException(409, 'This email already exists');\n      }\n      throw new HttpException(500, insertError.message);\n    }\n\n    if (!newUser) {\n      throw new HttpException(500, 'Failed to create user');\n    }\n\n    // Step 3: Create a session (so the frontend doesn't need to make a second \"login\" request)\n    // Note: This should succeed because we confirm the email immediately above.\n    const { data: signInData, error: signInError } = await supabaseAdmin.auth.signInWithPassword({\n      email: userData.email,\n      password: userData.password,\n    });\n\n    return {\n      user: newUser,\n      session: signInError ? null : signInData.session,\n    };\n  }\n\n  /**\n   * Login using Supabase Auth\n   * Validates password and returns user with session\n   */\n  public async login(userData: { email: string; password: string }): Promise<{ user: User; session: any }> {\n    if (isEmpty(userData)) throw new HttpException(400, 'Fields cannot be empty!');\n    if (!userData.password) {\n      throw new HttpException(400, 'Password is required');\n    }\n\n    // Use Supabase Auth to sign in (handles password verification)\n    const { data: authData, error: authError } = await supabaseAdmin.auth.signInWithPassword({\n      email: userData.email,\n      password: userData.password,\n    });\n\n    if (authError) {\n      if (authError.message.includes('Invalid login credentials')) {\n        throw new HttpException(401, 'Invalid email or password');\n      }\n      if (authError.message.includes('Email not confirmed')) {\n        throw new HttpException(403, 'Please verify your email before logging in');\n      }\n      throw new HttpException(500, authError.message);\n    }\n\n    if (!authData.user || !authData.session) {\n      throw new HttpException(401, 'Invalid email or password');\n    }\n\n    // Get user record from users table\n    const { data: user, error: userError } = await supabaseAdmin\n      .from('users')\n      .select('*')\n      .eq('auth_id', authData.user.id)\n      .single();\n\n    if (userError) {\n      throw new HttpException(500, 'Failed to fetch user data');\n    }\n\n    if (!user) {\n      throw new HttpException(404, 'User not found');\n    }\n\n    return {\n      user,\n      session: authData.session,\n    };\n  }\n\n  /**\n   * Delete account using Supabase Auth\n   * Deletes both auth user and user record\n   */\n  public async deleteAccount(userId: number): Promise<{ message: string }> {\n    if (isEmpty(userId)) throw new HttpException(400, 'User ID is required');\n\n    // Fetch auth_id before deleting the row\n    const { data: userRow, error: fetchError } = await supabaseAdmin\n      .from('users')\n      .select('auth_id')\n      .eq('id', userId)\n      .single();\n\n    if (fetchError) {\n      throw new HttpException(500, fetchError.message);\n    }\n\n    // Delete user record from users table\n    const { error: deleteError } = await supabaseAdmin\n      .from('users')\n      .delete()\n      .eq('id', userId);\n\n    if (deleteError) {\n      throw new HttpException(500, deleteError.message);\n    }\n\n    // Delete auth user (if linked)\n    if (userRow?.auth_id) {\n      const { error: authDeleteError } = await supabaseAdmin.auth.admin.deleteUser(userRow.auth_id);\n      if (authDeleteError) {\n        throw new HttpException(500, authDeleteError.message);\n      }\n    }\n\n    return { message: 'Account deleted successfully' };\n  }\n\n  /**\n   * Reset password using Supabase Auth\n   * Sends password reset email\n   */\n  public async resetPassword(email: string): Promise<{ message: string }> {\n    if (isEmpty(email)) throw new HttpException(400, 'Email is required');\n\n    const { error } = await supabaseAdmin.auth.resetPasswordForEmail(email, {\n      redirectTo: `${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/user-reset`,\n    });\n\n    if (error) {\n      throw new HttpException(500, error.message);\n    }\n\n    return { message: 'Password reset email sent' };\n  }\n\n  /**\n   * Update password using Supabase Auth\n   * Requires valid session token\n   */\n  public async updatePassword(userId: string, newPassword: string): Promise<{ message: string }> {\n    if (isEmpty(userId) || isEmpty(newPassword)) {\n      throw new HttpException(400, 'User ID and password are required');\n    }\n\n    if (newPassword.length < 6) {\n      throw new HttpException(400, 'Password must be at least 6 characters');\n    }\n\n    const { error } = await supabaseAdmin.auth.admin.updateUserById(userId, {\n      password: newPassword,\n    });\n\n    if (error) {\n      throw new HttpException(500, error.message);\n    }\n\n    return { message: 'Password updated successfully' };\n  }\n\n  /**\n   * Get user by ID\n   */\n  public async getUserByAuthId(authId: string): Promise<User> {\n    if (isEmpty(authId)) throw new HttpException(400, 'Auth ID is required');\n\n    const { data: user, error } = await supabaseAdmin\n      .from('users')\n      .select('*')\n      .eq('auth_id', authId)\n      .single();\n\n    if (error) {\n      if (error.code === 'PGRST116') {\n        throw new HttpException(404, 'User not found');\n      }\n      throw new HttpException(500, error.message);\n    }\n\n    if (!user) {\n      throw new HttpException(404, 'User not found');\n    }\n\n    return user;\n  }\n\n  /**\n   * Verify session token and get user\n   */\n  public async verifySession(accessToken: string): Promise<{ user: User; session: any }> {\n    if (isEmpty(accessToken)) throw new HttpException(401, 'Access token is required');\n\n    const { data: sessionData, error } = await supabaseAdmin.auth.getUser(accessToken);\n\n    if (error || !sessionData.user) {\n      throw new HttpException(401, 'Invalid or expired token');\n    }\n\n    const user = await this.getUserByAuthId(sessionData.user.id);\n\n    return {\n      user,\n      session: sessionData,\n    };\n  }\n}\n\nexport default UserAuthService;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 350, "column": 0}, "map": {"version":3,"sources":["file:///Users/remyngwanyam/Desktop/transapp/transapp-user-master/src/app/api/v1/bookings/cancel/%5BbookingId%5D/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { cookies } from 'next/headers';\nimport { supabaseAdmin } from '@databases/supabase';\nimport { HttpException } from '@exceptions/HttpException';\nimport UserAuthService from '@services/user.auth.service';\nimport type { Booking } from '@interfaces/booking.interface';\n\ninterface CancelResponse {\n  error: boolean;\n  message: string;\n  data?: Booking;\n}\n\nconst userAuthService = new UserAuthService();\n\nasync function getAccessToken(request: NextRequest): Promise<string | null> {\n  const authHeader = request.headers.get('authorization');\n  if (authHeader?.toLowerCase().startsWith('bearer ')) {\n    return authHeader.slice(7).trim();\n  }\n\n  const cookieStore = await cookies();\n  const sbAccessToken = cookieStore.get('sb-access-token')?.value;\n  if (sbAccessToken) return sbAccessToken;\n\n  const legacy = cookieStore.get('auth-token')?.value;\n  if (legacy) {\n    try {\n      const parsed = JSON.parse(legacy) as { token?: string };\n      if (parsed?.token) return parsed.token;\n    } catch {\n      // ignore\n    }\n  }\n  return null;\n}\n\nexport async function POST(\n  request: NextRequest,\n  context: { params: { bookingId: string } } | { params: Promise<{ bookingId: string }> }\n): Promise<NextResponse<CancelResponse>> {\n  try {\n    const { bookingId: bookingIdParam } = await (context as any).params;\n    const bookingId = Number(bookingIdParam);\n    if (!Number.isFinite(bookingId)) {\n      return NextResponse.json(\n        { error: true, message: 'Invalid booking id' },\n        { status: 400, headers: { 'Cache-Control': 'no-store' } }\n      );\n    }\n\n    const accessToken = await getAccessToken(request);\n    if (!accessToken) {\n      return NextResponse.json(\n        { error: true, message: 'Unauthorized' },\n        { status: 401, headers: { 'Cache-Control': 'no-store' } }\n      );\n    }\n\n    const { user } = await userAuthService.verifySession(accessToken);\n\n    const { data: booking, error: bookingError } = await supabaseAdmin\n      .from('bookings')\n      .select('*')\n      .eq('id', bookingId)\n      .eq('booker_id', user.id)\n      .single();\n\n    if (bookingError) {\n      if (bookingError.code === 'PGRST116') throw new HttpException(404, 'Booking not found');\n      throw new HttpException(500, bookingError.message);\n    }\n    if (!booking) throw new HttpException(404, 'Booking not found');\n\n    const status = (booking.status || '').toUpperCase();\n    if (status === 'CANCELLED') {\n      return NextResponse.json(\n        { error: false, message: 'Booking already cancelled', data: booking as Booking },\n        { headers: { 'Cache-Control': 'no-store' } }\n      );\n    }\n\n    // Prefer DB function (atomic release of seat + status update)\n    const { error: rpcError } = await supabaseAdmin.rpc('cancel_booking_release_seat', { p_booking_id: bookingId });\n    if (rpcError) {\n      // Fallback: mark cancelled + decrement trip reserved\n      await supabaseAdmin.from('bookings').update({ status: 'CANCELLED' }).eq('id', bookingId);\n      const { data: trip } = await supabaseAdmin.from('trips').select('reserved').eq('id', booking.trip_id).single();\n      const reserved = (trip as any)?.reserved ?? 0;\n      await supabaseAdmin.from('trips').update({ reserved: Math.max(0, Number(reserved) - 1) }).eq('id', booking.trip_id);\n    }\n\n    const { data: updated, error: updatedError } = await supabaseAdmin\n      .from('bookings')\n      .select('*')\n      .eq('id', bookingId)\n      .single();\n\n    if (updatedError) throw new HttpException(500, updatedError.message);\n\n    return NextResponse.json<CancelResponse>(\n      { error: false, message: 'Booking cancelled successfully', data: updated as Booking },\n      { headers: { 'Cache-Control': 'no-store' } }\n    );\n  } catch (error: unknown) {\n    const httpError = error as { status?: number; message?: string };\n    return NextResponse.json<CancelResponse>(\n      { error: true, message: httpError.message || 'Failed to cancel booking' },\n      { status: httpError.status || 500, headers: { 'Cache-Control': 'no-store' } }\n    );\n  }\n}\n\n\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AASA,MAAM,kBAAkB,IAAI,uJAAe;AAE3C,eAAe,eAAe,OAAoB;IAChD,MAAM,aAAa,QAAQ,OAAO,CAAC,GAAG,CAAC;IACvC,IAAI,YAAY,cAAc,WAAW,YAAY;QACnD,OAAO,WAAW,KAAK,CAAC,GAAG,IAAI;IACjC;IAEA,MAAM,cAAc,MAAM,IAAA,4IAAO;IACjC,MAAM,gBAAgB,YAAY,GAAG,CAAC,oBAAoB;IAC1D,IAAI,eAAe,OAAO;IAE1B,MAAM,SAAS,YAAY,GAAG,CAAC,eAAe;IAC9C,IAAI,QAAQ;QACV,IAAI;YACF,MAAM,SAAS,KAAK,KAAK,CAAC;YAC1B,IAAI,QAAQ,OAAO,OAAO,OAAO,KAAK;QACxC,EAAE,OAAM;QACN,SAAS;QACX;IACF;IACA,OAAO;AACT;AAEO,eAAe,KACpB,OAAoB,EACpB,OAAuF;IAEvF,IAAI;QACF,MAAM,EAAE,WAAW,cAAc,EAAE,GAAG,MAAM,AAAC,QAAgB,MAAM;QACnE,MAAM,YAAY,OAAO;QACzB,IAAI,CAAC,OAAO,QAAQ,CAAC,YAAY;YAC/B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;gBAAM,SAAS;YAAqB,GAC7C;gBAAE,QAAQ;gBAAK,SAAS;oBAAE,iBAAiB;gBAAW;YAAE;QAE5D;QAEA,MAAM,cAAc,MAAM,eAAe;QACzC,IAAI,CAAC,aAAa;YAChB,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;gBAAM,SAAS;YAAe,GACvC;gBAAE,QAAQ;gBAAK,SAAS;oBAAE,iBAAiB;gBAAW;YAAE;QAE5D;QAEA,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,gBAAgB,aAAa,CAAC;QAErD,MAAM,EAAE,MAAM,OAAO,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,yIAAa,CAC/D,IAAI,CAAC,YACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,WACT,EAAE,CAAC,aAAa,KAAK,EAAE,EACvB,MAAM;QAET,IAAI,cAAc;YAChB,IAAI,aAAa,IAAI,KAAK,YAAY,MAAM,IAAI,qJAAa,CAAC,KAAK;YACnE,MAAM,IAAI,qJAAa,CAAC,KAAK,aAAa,OAAO;QACnD;QACA,IAAI,CAAC,SAAS,MAAM,IAAI,qJAAa,CAAC,KAAK;QAE3C,MAAM,SAAS,CAAC,QAAQ,MAAM,IAAI,EAAE,EAAE,WAAW;QACjD,IAAI,WAAW,aAAa;YAC1B,OAAO,gJAAY,CAAC,IAAI,CACtB;gBAAE,OAAO;gBAAO,SAAS;gBAA6B,MAAM;YAAmB,GAC/E;gBAAE,SAAS;oBAAE,iBAAiB;gBAAW;YAAE;QAE/C;QAEA,8DAA8D;QAC9D,MAAM,EAAE,OAAO,QAAQ,EAAE,GAAG,MAAM,yIAAa,CAAC,GAAG,CAAC,+BAA+B;YAAE,cAAc;QAAU;QAC7G,IAAI,UAAU;YACZ,qDAAqD;YACrD,MAAM,yIAAa,CAAC,IAAI,CAAC,YAAY,MAAM,CAAC;gBAAE,QAAQ;YAAY,GAAG,EAAE,CAAC,MAAM;YAC9E,MAAM,EAAE,MAAM,IAAI,EAAE,GAAG,MAAM,yIAAa,CAAC,IAAI,CAAC,SAAS,MAAM,CAAC,YAAY,EAAE,CAAC,MAAM,QAAQ,OAAO,EAAE,MAAM;YAC5G,MAAM,WAAW,AAAC,MAAc,YAAY;YAC5C,MAAM,yIAAa,CAAC,IAAI,CAAC,SAAS,MAAM,CAAC;gBAAE,UAAU,KAAK,GAAG,CAAC,GAAG,OAAO,YAAY;YAAG,GAAG,EAAE,CAAC,MAAM,QAAQ,OAAO;QACpH;QAEA,MAAM,EAAE,MAAM,OAAO,EAAE,OAAO,YAAY,EAAE,GAAG,MAAM,yIAAa,CAC/D,IAAI,CAAC,YACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,WACT,MAAM;QAET,IAAI,cAAc,MAAM,IAAI,qJAAa,CAAC,KAAK,aAAa,OAAO;QAEnE,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAAO,SAAS;YAAkC,MAAM;QAAmB,GACpF;YAAE,SAAS;gBAAE,iBAAiB;YAAW;QAAE;IAE/C,EAAE,OAAO,OAAgB;QACvB,MAAM,YAAY;QAClB,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,OAAO;YAAM,SAAS,UAAU,OAAO,IAAI;QAA2B,GACxE;YAAE,QAAQ,UAAU,MAAM,IAAI;YAAK,SAAS;gBAAE,iBAAiB;YAAW;QAAE;IAEhF;AACF"}}]
}