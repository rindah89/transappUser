{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/remyngwanyam/Desktop/transapp/transapp-user-master/src/proxy.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport type { NextRequest } from 'next/server';\nimport { createClient } from '@supabase/supabase-js';\nimport type { Database } from './types/database.types';\n\n/**\n * Proxy - Handles authentication checks and route protection at the edge using Supabase Auth\n * Replaces the deprecated middleware file convention\n */\nexport async function proxy(request: NextRequest) {\n  const { pathname } = request.nextUrl;\n  \n  // Initialize Supabase client for proxy\n  const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;\n  const supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY;\n  \n  if (!supabaseUrl || !supabaseAnonKey) {\n    // If Supabase is not configured, allow request through\n    return NextResponse.next();\n  }\n\n  const supabase = createClient<Database>(supabaseUrl, supabaseAnonKey, {\n    auth: {\n      persistSession: false,\n      autoRefreshToken: false,\n    },\n  });\n\n  // Get access token from cookies or headers\n  // - Prefer raw JWT in `sb-access-token`\n  // - Support legacy `auth-token` cookie which stores JSON { user, token }\n  const authTokenCookie = request.cookies.get('auth-token')?.value;\n  let accessToken =\n    request.cookies.get('sb-access-token')?.value ||\n    request.headers.get('authorization')?.replace('Bearer ', '') ||\n    undefined;\n\n  if (!accessToken && authTokenCookie) {\n    try {\n      const parsed = JSON.parse(authTokenCookie) as { token?: string };\n      if (parsed?.token) accessToken = parsed.token;\n    } catch {\n      // If it's not JSON, treat it as a raw token\n      accessToken = authTokenCookie;\n    }\n  }\n\n  let user = null;\n\n  // Verify token with Supabase Auth\n  if (accessToken) {\n    try {\n      const { data: { user: authUser }, error } = await supabase.auth.getUser(accessToken);\n      if (!error && authUser) {\n        user = authUser;\n      }\n    } catch {\n      // Invalid token, continue without auth\n    }\n  }\n\n  // Protected routes that require authentication (dashboard routes)\n  const protectedRoutes = [\n    '/user-bookings',\n    '/ticket-form',\n    '/ticket-summary',\n    '/book',\n    '/trip-search',\n    '/search-results',\n    '/about-transapp',\n    '/privacy-policy',\n    '/terms',\n  ];\n\n  // Auth routes (public routes)\n  const authRoutes = [\n    '/login',\n    '/register',\n    '/user-forgot',\n    '/user-reset',\n    '/trip-login',\n    '/transapp-delete-my-account',\n    '/pay',\n    '/payunit-return',\n  ];\n\n  // Check if the route is protected\n  const isProtectedRoute = protectedRoutes.some(route => pathname.startsWith(route));\n  // Keep authRoutes list for future checks/redirects if needed.\n  authRoutes.some(route => pathname.startsWith(route));\n\n  // If accessing a protected route without valid session, redirect to login\n  if (isProtectedRoute && !user) {\n    const url = request.nextUrl.clone();\n    url.pathname = '/login';\n    url.searchParams.set('redirect', pathname);\n    return NextResponse.redirect(url);\n  }\n\n  // Note: we intentionally do NOT redirect authenticated users away from auth routes.\n  // This avoids trapping users in cases where cookies exist but client state/localStorage is out of sync.\n\n  return NextResponse.next();\n}\n\nexport const config = {\n  matcher: [\n    /*\n     * Match all request paths except for the ones starting with:\n     * - api (API routes)\n     * - _next/static (static files)\n     * - _next/image (image optimization files)\n     * - favicon.ico (favicon file)\n     * - public files (public folder)\n     */\n    '/((?!api|_next/static|_next/image|favicon.ico|.*\\\\.(?:svg|png|jpg|jpeg|gif|webp)$).*)',\n  ],\n};\n\n"],"names":[],"mappings":";;;;;;AAAA;AAEA;;;AAOO,eAAe,MAAM,OAAoB;IAC9C,MAAM,EAAE,QAAQ,EAAE,GAAG,QAAQ,OAAO;IAEpC,uCAAuC;IACvC,MAAM,cAAc,gFAAwC,QAAQ,GAAG,CAAC,YAAY;IACpF,MAAM,kBAAkB,QAAQ,GAAG,CAAC,6BAA6B;IAEjE;;IAKA,MAAM,WAAW,IAAA,uLAAY,EAAW,aAAa,iBAAiB;QACpE,MAAM;YACJ,gBAAgB;YAChB,kBAAkB;QACpB;IACF;IAEA,2CAA2C;IAC3C,wCAAwC;IACxC,yEAAyE;IACzE,MAAM,kBAAkB,QAAQ,OAAO,CAAC,GAAG,CAAC,eAAe;IAC3D,IAAI,cACF,QAAQ,OAAO,CAAC,GAAG,CAAC,oBAAoB,SACxC,QAAQ,OAAO,CAAC,GAAG,CAAC,kBAAkB,QAAQ,WAAW,OACzD;IAEF,IAAI,CAAC,eAAe,iBAAiB;QACnC,IAAI;YACF,MAAM,SAAS,KAAK,KAAK,CAAC;YAC1B,IAAI,QAAQ,OAAO,cAAc,OAAO,KAAK;QAC/C,EAAE,OAAM;YACN,4CAA4C;YAC5C,cAAc;QAChB;IACF;IAEA,IAAI,OAAO;IAEX,kCAAkC;IAClC,IAAI,aAAa;QACf,IAAI;YACF,MAAM,EAAE,MAAM,EAAE,MAAM,QAAQ,EAAE,EAAE,KAAK,EAAE,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO,CAAC;YACxE,IAAI,CAAC,SAAS,UAAU;gBACtB,OAAO;YACT;QACF,EAAE,OAAM;QACN,uCAAuC;QACzC;IACF;IAEA,kEAAkE;IAClE,MAAM,kBAAkB;QACtB;QACA;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,8BAA8B;IAC9B,MAAM,aAAa;QACjB;QACA;QACA;QACA;QACA;QACA;QACA;QACA;KACD;IAED,kCAAkC;IAClC,MAAM,mBAAmB,gBAAgB,IAAI,CAAC,CAAA,QAAS,SAAS,UAAU,CAAC;IAC3E,8DAA8D;IAC9D,WAAW,IAAI,CAAC,CAAA,QAAS,SAAS,UAAU,CAAC;IAE7C,0EAA0E;IAC1E,IAAI,oBAAoB,CAAC,MAAM;QAC7B,MAAM,MAAM,QAAQ,OAAO,CAAC,KAAK;QACjC,IAAI,QAAQ,GAAG;QACf,IAAI,YAAY,CAAC,GAAG,CAAC,YAAY;QACjC,OAAO,8IAAY,CAAC,QAAQ,CAAC;IAC/B;IAEA,oFAAoF;IACpF,wGAAwG;IAExG,OAAO,8IAAY,CAAC,IAAI;AAC1B;AAEO,MAAM,SAAS;IACpB,SAAS;QACP;;;;;;;KAOC,GACD;KACD;AACH"}}]
}