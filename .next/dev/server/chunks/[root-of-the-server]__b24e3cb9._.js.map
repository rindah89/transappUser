{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/remyngwanyam/Desktop/transapp/transapp-user-master/src/lib/supabase.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport { Database } from '../types/database.types';\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.SUPABASE_URL;\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY;\nconst supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl) {\n  throw new Error('Missing NEXT_PUBLIC_SUPABASE_URL or SUPABASE_URL environment variable');\n}\n\nif (!supabaseAnonKey && !supabaseServiceKey) {\n  throw new Error('Missing NEXT_PUBLIC_SUPABASE_ANON_KEY, NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY, or SUPABASE_SERVICE_ROLE_KEY environment variable');\n}\n\n// Client for client-side operations (uses anon/publishable key, respects RLS)\nexport const supabase = supabaseAnonKey\n  ? createClient<Database>(supabaseUrl, supabaseAnonKey, {\n      auth: {\n        persistSession: true,\n        autoRefreshToken: true,\n        detectSessionInUrl: true\n      }\n    })\n  : null;\n\n// Client for server-side admin operations (uses service role key - REQUIRED for API routes)\n// WARNING: Only use this in API routes or getServerSideProps. NEVER expose to client.\n// Only check for service key on server side (not during client-side module evaluation)\nconst isServer = typeof window === 'undefined';\n\nif (isServer && !supabaseServiceKey) {\n  console.error('⚠️  SUPABASE_SERVICE_ROLE_KEY is missing! Server-side API routes will not work.');\n  console.error('   Get it from: Supabase Dashboard → Settings → API → service_role key');\n  console.error('   Make sure it\\'s in your .env.local file (not .env, as .env.local is not committed to git)');\n}\n\nexport const supabaseAdmin = supabaseServiceKey\n  ? createClient<Database>(supabaseUrl, supabaseServiceKey, {\n      auth: {\n        autoRefreshToken: false,\n        persistSession: false,\n        detectSessionInUrl: false\n      },\n      db: {\n        schema: 'public'\n      }\n    })\n  : (() => {\n      // Only throw error on server side when actually trying to use it\n      if (isServer) {\n        throw new Error(\n          'SUPABASE_SERVICE_ROLE_KEY is required for server-side operations.\\n' +\n          'Please add it to your .env.local file:\\n' +\n          'SUPABASE_SERVICE_ROLE_KEY=your-service-role-key-here\\n' +\n          'Get it from: Supabase Dashboard → Settings → API → service_role key'\n        );\n      }\n      // On client side, return a dummy object that will throw if used\n      return null as any;\n    })();\n"],"names":[],"mappings":";;;;;;AAAA;;AAGA,MAAM,cAAc,gFAAwC,QAAQ,GAAG,CAAC,YAAY;AACpF,MAAM,kBAAkB,QAAQ,GAAG,CAAC,6BAA6B;AACjE,MAAM,qBAAqB,QAAQ,GAAG,CAAC,yBAAyB;AAEhE;;AAIA;;AAKO,MAAM,WAAW,uCACpB,IAAA,yLAAY,EAAW,aAAa,iBAAiB;IACnD,MAAM;QACJ,gBAAgB;QAChB,kBAAkB;QAClB,oBAAoB;IACtB;AACF,KACA;AAEJ,4FAA4F;AAC5F,sFAAsF;AACtF,uFAAuF;AACvF,MAAM,WAAW,kDAAkB;AAEnC,IAAI,YAAY,CAAC,oBAAoB;IACnC,QAAQ,KAAK,CAAC;IACd,QAAQ,KAAK,CAAC;IACd,QAAQ,KAAK,CAAC;AAChB;AAEO,MAAM,gBAAgB,qBACzB,IAAA,yLAAY,EAAW,aAAa,oBAAoB;IACtD,MAAM;QACJ,kBAAkB;QAClB,gBAAgB;QAChB,oBAAoB;IACtB;IACA,IAAI;QACF,QAAQ;IACV;AACF,KACA,CAAC;IACC,iEAAiE;IACjE,wCAAc;QACZ,MAAM,IAAI,MACR,wEACA,6CACA,2DACA;IAEJ;IACA,gEAAgE;IAChE,OAAO;AACT,CAAC"}},
    {"offset": {"line": 98, "column": 0}, "map": {"version":3,"sources":["file:///Users/remyngwanyam/Desktop/transapp/transapp-user-master/src/exceptions/HttpException.ts"],"sourcesContent":["export class HttpException extends Error {\n  public status: number;\n  public message: string;\n\n  constructor(status: number, message: string) {\n    super(message);\n    this.status = status;\n    this.message = message;\n  }\n}\n"],"names":[],"mappings":";;;;AAAO,MAAM,sBAAsB;IAC1B,OAAe;IACf,QAAgB;IAEvB,YAAY,MAAc,EAAE,OAAe,CAAE;QAC3C,KAAK,CAAC;QACN,IAAI,CAAC,MAAM,GAAG;QACd,IAAI,CAAC,OAAO,GAAG;IACjB;AACF"}},
    {"offset": {"line": 115, "column": 0}, "map": {"version":3,"sources":["file:///Users/remyngwanyam/Desktop/transapp/transapp-user-master/src/utils/util.ts"],"sourcesContent":["/**\n * @method isEmpty\n * @param {String | Number | Object} value\n * @returns {Boolean} true & false\n * @description this value is Empty Check\n */\nexport const isEmpty = (value: string | number | object): boolean => {\n  if (value === null) {\n    return true;\n  } else if (typeof value !== 'number' && value === '') {\n    return true;\n  } else if (typeof value === 'undefined' || value === undefined) {\n    return true;\n  } else if (value !== null && typeof value === 'object' && !Object.keys(value).length) {\n    return true;\n  } else {\n    return false;\n  }\n};\n"],"names":[],"mappings":"AAAA;;;;;CAKC;;;;AACM,MAAM,UAAU,CAAC;IACtB,IAAI,UAAU,MAAM;QAClB,OAAO;IACT,OAAO,IAAI,OAAO,UAAU,YAAY,UAAU,IAAI;QACpD,OAAO;IACT,OAAO,IAAI,OAAO,UAAU,eAAe,UAAU,WAAW;QAC9D,OAAO;IACT,OAAO,IAAI,UAAU,QAAQ,OAAO,UAAU,YAAY,CAAC,OAAO,IAAI,CAAC,OAAO,MAAM,EAAE;QACpF,OAAO;IACT,OAAO;QACL,OAAO;IACT;AACF"}},
    {"offset": {"line": 141, "column": 0}, "map": {"version":3,"sources":["file:///Users/remyngwanyam/Desktop/transapp/transapp-user-master/src/services/user.auth.service.ts"],"sourcesContent":["import { supabaseAdmin } from '@databases/supabase';\nimport { HttpException } from '../exceptions/HttpException';\nimport { isEmpty } from '../utils/util';\nimport type { UserInsert, User } from '../interfaces/user.interface';\n\nclass UserAuthService {\n  /**\n   * Sign up a new user using Supabase Auth\n   * Creates auth user and then creates user record in users table\n   */\n  public async signup(userData: {\n    email: string;\n    password: string;\n    name?: string;\n    sex?: string;\n    age?: number;\n    phoneNumber?: string;\n    idCardNumber?: string;\n  }): Promise<{ user: User; session: any }> {\n    if (isEmpty(userData)) throw new HttpException(400, 'Invalid credentials!');\n    if (!userData.password || userData.password.length < 6) {\n      throw new HttpException(400, 'Password must be at least 6 characters');\n    }\n\n    // Step 1: Create auth user using Supabase Admin API\n    // We confirm the email immediately so the user can be logged in right after signup.\n    const { data: authData, error: authError } = await supabaseAdmin.auth.admin.createUser({\n      email: userData.email,\n      password: userData.password,\n      email_confirm: true,\n      user_metadata: {\n        name: userData.name,\n        phone_number: userData.phoneNumber,\n      },\n    });\n\n    if (authError) {\n      if (authError.message.includes('already registered')) {\n        throw new HttpException(409, 'This email already exists');\n      }\n      throw new HttpException(500, authError.message);\n    }\n\n    if (!authData.user) {\n      throw new HttpException(500, 'Failed to create auth user');\n    }\n\n    // Step 2: Create user record in users table with auth user ID\n    const userInsert: UserInsert = {\n      auth_id: authData.user.id, // Link to Supabase Auth user UUID\n      email: userData.email,\n      name: userData.name || null,\n      sex: userData.sex || null,\n      age: userData.age || null,\n      phone_number: userData.phoneNumber || null,\n      id_card_number: userData.idCardNumber || null,\n    };\n\n    const { data: newUser, error: insertError } = await supabaseAdmin\n      .from('users')\n      .insert(userInsert)\n      .select()\n      .single();\n\n    if (insertError) {\n      // If user table insert fails, try to clean up auth user\n      if (authData.user) {\n        await supabaseAdmin.auth.admin.deleteUser(authData.user.id);\n      }\n      \n      if (insertError.code === '23505') {\n        throw new HttpException(409, 'This email already exists');\n      }\n      throw new HttpException(500, insertError.message);\n    }\n\n    if (!newUser) {\n      throw new HttpException(500, 'Failed to create user');\n    }\n\n    // Step 3: Create a session (so the frontend doesn't need to make a second \"login\" request)\n    // Note: This should succeed because we confirm the email immediately above.\n    const { data: signInData, error: signInError } = await supabaseAdmin.auth.signInWithPassword({\n      email: userData.email,\n      password: userData.password,\n    });\n\n    return {\n      user: newUser,\n      session: signInError ? null : signInData.session,\n    };\n  }\n\n  /**\n   * Login using Supabase Auth\n   * Validates password and returns user with session\n   */\n  public async login(userData: { email: string; password: string }): Promise<{ user: User; session: any }> {\n    if (isEmpty(userData)) throw new HttpException(400, 'Fields cannot be empty!');\n    if (!userData.password) {\n      throw new HttpException(400, 'Password is required');\n    }\n\n    // Use Supabase Auth to sign in (handles password verification)\n    const { data: authData, error: authError } = await supabaseAdmin.auth.signInWithPassword({\n      email: userData.email,\n      password: userData.password,\n    });\n\n    if (authError) {\n      if (authError.message.includes('Invalid login credentials')) {\n        throw new HttpException(401, 'Invalid email or password');\n      }\n      if (authError.message.includes('Email not confirmed')) {\n        throw new HttpException(403, 'Please verify your email before logging in');\n      }\n      throw new HttpException(500, authError.message);\n    }\n\n    if (!authData.user || !authData.session) {\n      throw new HttpException(401, 'Invalid email or password');\n    }\n\n    // Get user record from users table\n    const { data: user, error: userError } = await supabaseAdmin\n      .from('users')\n      .select('*')\n      .eq('auth_id', authData.user.id)\n      .single();\n\n    if (userError) {\n      throw new HttpException(500, 'Failed to fetch user data');\n    }\n\n    if (!user) {\n      throw new HttpException(404, 'User not found');\n    }\n\n    return {\n      user,\n      session: authData.session,\n    };\n  }\n\n  /**\n   * Delete account using Supabase Auth\n   * Deletes both auth user and user record\n   */\n  public async deleteAccount(userId: number): Promise<{ message: string }> {\n    if (isEmpty(userId)) throw new HttpException(400, 'User ID is required');\n\n    // Fetch auth_id before deleting the row\n    const { data: userRow, error: fetchError } = await supabaseAdmin\n      .from('users')\n      .select('auth_id')\n      .eq('id', userId)\n      .single();\n\n    if (fetchError) {\n      throw new HttpException(500, fetchError.message);\n    }\n\n    // Delete user record from users table\n    const { error: deleteError } = await supabaseAdmin\n      .from('users')\n      .delete()\n      .eq('id', userId);\n\n    if (deleteError) {\n      throw new HttpException(500, deleteError.message);\n    }\n\n    // Delete auth user (if linked)\n    if (userRow?.auth_id) {\n      const { error: authDeleteError } = await supabaseAdmin.auth.admin.deleteUser(userRow.auth_id);\n      if (authDeleteError) {\n        throw new HttpException(500, authDeleteError.message);\n      }\n    }\n\n    return { message: 'Account deleted successfully' };\n  }\n\n  /**\n   * Reset password using Supabase Auth\n   * Sends password reset email\n   */\n  public async resetPassword(email: string): Promise<{ message: string }> {\n    if (isEmpty(email)) throw new HttpException(400, 'Email is required');\n\n    const { error } = await supabaseAdmin.auth.resetPasswordForEmail(email, {\n      redirectTo: `${process.env.NEXT_PUBLIC_APP_URL || 'http://localhost:3000'}/user-reset`,\n    });\n\n    if (error) {\n      throw new HttpException(500, error.message);\n    }\n\n    return { message: 'Password reset email sent' };\n  }\n\n  /**\n   * Update password using Supabase Auth\n   * Requires valid session token\n   */\n  public async updatePassword(userId: string, newPassword: string): Promise<{ message: string }> {\n    if (isEmpty(userId) || isEmpty(newPassword)) {\n      throw new HttpException(400, 'User ID and password are required');\n    }\n\n    if (newPassword.length < 6) {\n      throw new HttpException(400, 'Password must be at least 6 characters');\n    }\n\n    const { error } = await supabaseAdmin.auth.admin.updateUserById(userId, {\n      password: newPassword,\n    });\n\n    if (error) {\n      throw new HttpException(500, error.message);\n    }\n\n    return { message: 'Password updated successfully' };\n  }\n\n  /**\n   * Get user by ID\n   */\n  public async getUserByAuthId(authId: string): Promise<User> {\n    if (isEmpty(authId)) throw new HttpException(400, 'Auth ID is required');\n\n    const { data: user, error } = await supabaseAdmin\n      .from('users')\n      .select('*')\n      .eq('auth_id', authId)\n      .single();\n\n    if (error) {\n      if (error.code === 'PGRST116') {\n        throw new HttpException(404, 'User not found');\n      }\n      throw new HttpException(500, error.message);\n    }\n\n    if (!user) {\n      throw new HttpException(404, 'User not found');\n    }\n\n    return user;\n  }\n\n  /**\n   * Verify session token and get user\n   */\n  public async verifySession(accessToken: string): Promise<{ user: User; session: any }> {\n    if (isEmpty(accessToken)) throw new HttpException(401, 'Access token is required');\n\n    const { data: sessionData, error } = await supabaseAdmin.auth.getUser(accessToken);\n\n    if (error || !sessionData.user) {\n      throw new HttpException(401, 'Invalid or expired token');\n    }\n\n    const user = await this.getUserByAuthId(sessionData.user.id);\n\n    return {\n      user,\n      session: sessionData,\n    };\n  }\n}\n\nexport default UserAuthService;\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 350, "column": 0}, "map": {"version":3,"sources":["file:///Users/remyngwanyam/Desktop/transapp/transapp-user-master/src/app/api/v1/bookings/user-bookings/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from 'next/server';\nimport { cookies } from 'next/headers';\nimport { supabaseAdmin } from '@databases/supabase';\nimport { HttpException } from '@exceptions/HttpException';\nimport UserAuthService from '@services/user.auth.service';\nimport type { Booking } from '@interfaces/booking.interface';\n\ninterface BookingsResponse {\n  error: boolean;\n  message: string;\n  data?: Booking[];\n}\n\nconst userAuthService = new UserAuthService();\n\nasync function getAccessToken(request: NextRequest): Promise<string | null> {\n  const authHeader = request.headers.get('authorization');\n  if (authHeader?.toLowerCase().startsWith('bearer ')) {\n    return authHeader.slice(7).trim();\n  }\n\n  const cookieStore = await cookies();\n  const sbAccessToken = cookieStore.get('sb-access-token')?.value;\n  if (sbAccessToken) return sbAccessToken;\n\n  const legacy = cookieStore.get('auth-token')?.value;\n  if (legacy) {\n    try {\n      const parsed = JSON.parse(legacy) as { token?: string };\n      if (parsed?.token) return parsed.token;\n    } catch {\n      // ignore\n    }\n  }\n\n  return null;\n}\n\nfunction parseJourneyDeparture(journeyDate: string, departureTime: string): Date | null {\n  if (!journeyDate || !departureTime) return null;\n\n  // Handles \"HH:mm\" and also attempts \"h:mm A\" (e.g., \"6:30 PM\")\n  const trimmed = departureTime.trim();\n  const ampm = trimmed.match(/(\\d{1,2}):(\\d{2})\\s*([AaPp][Mm])/);\n  if (ampm) {\n    let h = Number(ampm[1]);\n    const m = Number(ampm[2]);\n    const ap = ampm[3].toLowerCase();\n    if (ap === 'pm' && h < 12) h += 12;\n    if (ap === 'am' && h === 12) h = 0;\n    const dt = new Date(`${journeyDate}T00:00:00`);\n    if (Number.isNaN(dt.getTime())) return null;\n    dt.setHours(h, m, 0, 0);\n    return dt;\n  }\n\n  const hm = trimmed.match(/^(\\d{1,2}):(\\d{2})$/);\n  if (hm) {\n    const h = Number(hm[1]);\n    const m = Number(hm[2]);\n    const dt = new Date(`${journeyDate}T00:00:00`);\n    if (Number.isNaN(dt.getTime())) return null;\n    dt.setHours(h, m, 0, 0);\n    return dt;\n  }\n\n  // Last resort\n  const parsed = new Date(`${journeyDate} ${trimmed}`);\n  return Number.isNaN(parsed.getTime()) ? null : parsed;\n}\n\nasync function cancelBookingReleaseSeat(bookingId: number, tripId: number): Promise<void> {\n  // Prefer DB function (atomic)\n  const { error: rpcError } = await supabaseAdmin.rpc('cancel_booking_release_seat', { p_booking_id: bookingId });\n  if (!rpcError) return;\n\n  // Fallback: mark cancelled + decrement trip reserved\n  await supabaseAdmin.from('bookings').update({ status: 'CANCELLED' }).eq('id', bookingId);\n\n  const { data: trip } = await supabaseAdmin.from('trips').select('reserved').eq('id', tripId).single();\n  const reserved = (trip as any)?.reserved ?? 0;\n  await supabaseAdmin.from('trips').update({ reserved: Math.max(0, Number(reserved) - 1) }).eq('id', tripId);\n}\n\n// Next.js 16 best practice: Use async request APIs with caching\nexport async function GET(request: NextRequest): Promise<NextResponse<BookingsResponse>> {\n  try {\n    \n    const searchParams = request.nextUrl.searchParams;\n    const userIdParam = searchParams.get('userId');\n    let userId: number | null = userIdParam ? Number(userIdParam) : null;\n\n    // Prefer auth-based lookup if userId not provided (or invalid)\n    if (!userId || !Number.isFinite(userId)) {\n      const accessToken = await getAccessToken(request);\n      if (!accessToken) {\n        return NextResponse.json(\n          { error: true, message: 'Unauthorized' },\n          { status: 401, headers: { 'Cache-Control': 'no-store' } }\n        );\n      }\n      const { user } = await userAuthService.verifySession(accessToken);\n      userId = user.id;\n    }\n\n    const currentYear = new Date().getFullYear().toString();\n\n    const { data, error } = await supabaseAdmin\n      .from('bookings')\n      .select('*')\n      .eq('booker_id', userId)\n      .eq('year', currentYear)\n      .order('created_at', { ascending: false });\n\n    if (error) {\n      throw new HttpException(500, error.message);\n    }\n\n    const bookings = ((data || []) as Booking[]);\n\n    // Auto-cancel reservations 30 mins before departure time\n    // BUT only if they are still unpaid / unconfirmed (i.e. not marked as Paid/Confirmed by admin app)\n    const now = Date.now();\n    const protectedStatuses = new Set(['PAID', 'CONFIRMED', 'BOOKED']);\n    const cancelableStatuses = new Set(['', 'PENDING', 'RESERVED', 'CASH_PENDING']);\n\n    const toCancel = bookings.filter((b) => {\n      const status = String(b.status ?? '').trim().toUpperCase();\n\n      // Never auto-cancel if admin/payment already confirmed it\n      if (protectedStatuses.has(status)) return false;\n      if ((b as any)?.transaction_id) return false;\n\n      // Never auto-cancel already-cancelled items (handle various spellings/casing)\n      if (status.startsWith('CANCEL')) return false;\n\n      return cancelableStatuses.has(status);\n    });\n    for (const b of toCancel) {\n      const dt = parseJourneyDeparture(b.journey_date, b.departure_time);\n      if (!dt) continue;\n      const cutoff = dt.getTime() - 30 * 60 * 1000;\n      if (now >= cutoff) {\n        try {\n          await cancelBookingReleaseSeat(b.id, b.trip_id);\n          b.status = 'CANCELLED';\n        } catch {\n          // ignore\n        }\n      }\n    }\n\n    return NextResponse.json<BookingsResponse>({\n      error: false,\n      message: 'Bookings retrieved successfully',\n      data: bookings,\n    }, {\n      headers: {\n        // Cache for 30 seconds, revalidate in background\n        'Cache-Control': 'private, s-maxage=30, stale-while-revalidate=60',\n      },\n    });\n  } catch (error: unknown) {\n    const httpError = error as { status?: number; message?: string };\n    return NextResponse.json<BookingsResponse>(\n      {\n        error: true,\n        message: httpError.message || 'Failed to retrieve bookings',\n      },\n      { \n        status: httpError.status || 500,\n        headers: {\n          'Cache-Control': 'no-store',\n        },\n      }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}